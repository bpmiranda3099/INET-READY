# INET-READY Notification System

This document provides a comprehensive overview of the notification system in INET-READY, including implementation details, message types, delivery mechanisms, and configuration options.

## Notification Architecture

The INET-READY notification system combines real-time alerts with historical tracking to keep users informed about significant heat index changes and weather conditions.

### Components

1. **Firebase Cloud Messaging (FCM)**

   - Cross-platform push notification delivery
   - Support for web and mobile devices
   - Token-based subscriber management

2. **Service Worker**

   - Located at: `static/firebase-messaging-sw.js`
   - Handles background and foreground notifications
   - Maintains notification when app is closed

3. **Notification Service**

   - Core notification logic in `src/scripts/heat_index_alert_service.py`
   - Determines when to send notifications based on thresholds
   - Formats notification content based on heat index changes

4. **Notification History**
   - Stored in Firestore collection: `notification_history`
   - Accessible through the Notifications tab in the app
   - Categorized by type (Emergency, System, Reminder, Settings)

## Notification Types

### 1. Heat Index Alerts

Triggered when significant heat index changes are detected:

- **Heat Index Increase Alert** (≥15% increase)

  - Severity: High
  - Message: "Heat Index Alert: Significant increase detected in {city_name}. Stay indoors and always hydrate!"
  - Contains: Current value, previous value, percent change, INET level

- **Heat Index Decrease Update** (≥10% decrease)
  - Severity: Medium
  - Message: "Heat Index Update: Heat index has decreased in {city_name}."
  - Contains: Current value, previous value, percent change, INET level

### 2. Daily Weather Insights

- **AI-Generated Weather Summary**
  - Frequency: Daily
  - Content: Personalized weather insights and health recommendations
  - Generated by: Google Gemini AI through Node.js bridge

### 3. System Notifications

- **Account-related**: Email verification, password resets
- **Medical Profile Updates**: Risk level changes, profile completion reminders
- **Permission Changes**: Location or notification permission changes

### 4. Travel Safety Alerts

- **Travel Risk Notifications**: Safety status between cities
- **Destination Alerts**: Heat index warnings for travel destinations

## Implementation Details

### Heat Index Alert Service

The `heat_index_alert_service.py` script is the core of the notification system:

```python
def send_notifications(significant_changes, db):
    """
    Send notifications for cities with significant heat index changes.

    Args:
        significant_changes (list): List of dictionaries containing city data with significant changes
        db: Firestore database reference

    Returns:
        dict: Results summary with success and failure counts by city
    """
    results = {}

    for change in significant_changes:
        city = change['city']
        current_value = change['current_value']
        previous_value = change['previous_value']
        percent_change = change['percent_change']
        change_type = change['type']
        inet_level = change['inet_level']

        # Get user tokens for this city
        user_tokens = get_user_tokens_for_city(city, db)
        if not user_tokens:
            logger.info(f"No user tokens found for city: {city}")
            continue

        # Create notification message based on change type
        if change_type == 'increase':
            title = f"Heat Index Alert: {city}"
            body = f"Significant increase detected in {city}. Stay indoors and always hydrate!"
        else:  # decrease
            title = f"Heat Index Update: {city}"
            body = f"Heat index has decreased in {city}."

        # Notification data for storing in notification history
        notification_data = {
            'type': change_type,
            'city': city,
            'current_value': current_value,
            'previous_value': previous_value,
            'percent_change': percent_change,
            'inet_level': inet_level,
            'timestamp': firestore.SERVER_TIMESTAMP
        }

        # Send notification to each user token
        success_count = 0
        failure_count = 0

        for token in user_tokens:
            try:
                # Send message via FCM
                message = messaging.Message(
                    notification=messaging.Notification(
                        title=title,
                        body=body
                    ),
                    data=notification_data,
                    token=token
                )

                response = messaging.send(message)
                success_count += 1

                # Store in notification history
                db.collection('notification_history').add({
                    'token': token,
                    'title': title,
                    'body': body,
                    'data': notification_data,
                    'status': 'success',
                    'timestamp': firestore.SERVER_TIMESTAMP
                })

            except Exception as e:
                logger.error(f"Failed to send notification to token for {city}: {e}")
                failure_count += 1

                # Store failure in notification history
                db.collection('notification_history').add({
                    'token': token,
                    'title': title,
                    'body': body,
                    'data': notification_data,
                    'status': 'failure',
                    'error': str(e),
                    'timestamp': firestore.SERVER_TIMESTAMP
                })

        # Record results for this city
        results[city] = {
            'success': success_count,
            'failure': failure_count
        }

        logger.info(f"Notifications for {city}: {success_count} successful, {failure_count} failed")

    return results
```

### Service Worker Registration

Client-side notification setup in the frontend:

```javascript
// In src/lib/firebase.js
export async function initializeFirebaseMessaging() {
	try {
		const messaging = getMessaging(app);

		// Register service worker if browser supports it
		if ('serviceWorker' in navigator) {
			const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
				scope: '/'
			});

			// Request permission and get token
			const permission = await Notification.requestPermission();
			if (permission === 'granted') {
				const currentToken = await getToken(messaging, {
					vapidKey: import.meta.env.VITE_FIREBASE_VAPID_KEY,
					serviceWorkerRegistration: registration
				});

				if (currentToken) {
					// Save token to user's profile in Firestore
					const user = auth.currentUser;
					if (user) {
						await updateDoc(doc(db, 'users', user.uid), {
							fcmTokens: arrayUnion(currentToken)
						});
					}
					return currentToken;
				}
			}
		}
	} catch (error) {
		console.error('Failed to initialize Firebase Messaging:', error);
	}
	return null;
}
```

### Service Worker Implementation

The Firebase Messaging service worker (`static/firebase-messaging-sw.js`):

```javascript
importScripts('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js');

// Initialize Firebase app in the service worker
firebase.initializeApp({
	apiKey: 'YOUR_API_KEY',
	authDomain: 'YOUR_AUTH_DOMAIN',
	projectId: 'YOUR_PROJECT_ID',
	storageBucket: 'YOUR_STORAGE_BUCKET',
	messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',
	appId: 'YOUR_APP_ID',
	measurementId: 'YOUR_MEASUREMENT_ID'
});

const messaging = firebase.messaging();

// Handle background messages
messaging.onBackgroundMessage((payload) => {
	console.log('Background message received:', payload);

	const notificationTitle = payload.notification.title;
	const notificationOptions = {
		body: payload.notification.body,
		icon: '/app-icon.png',
		data: payload.data
	};

	// Show notification
	self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification click
self.addEventListener('notificationclick', (event) => {
	event.notification.close();

	// This opens the app and passes the notification data
	event.waitUntil(clients.openWindow('/'));
});
```

## Notification Testing

For testing notifications, use the Firebase Cloud Function in `functions/sendTestNotification.js`:

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.sendTestNotification = functions.https.onCall(async (data, context) => {
	// Ensure user is authenticated
	if (!context.auth) {
		throw new functions.https.HttpsError(
			'unauthenticated',
			'The function must be called while authenticated.'
		);
	}

	const { token, title, body } = data;

	try {
		await admin.messaging().send({
			notification: {
				title,
				body
			},
			token
		});

		return { success: true };
	} catch (error) {
		console.error('Error sending notification:', error);
		return {
			success: false,
			error: error.message
		};
	}
});
```

## Notification History Component

The notification history UI component (`src/components/notification-history.svelte`) displays past notifications organized by category:

```svelte
<script>
	import { onMount } from 'svelte';
	import { db, auth } from '$lib/firebase';
	import { collection, query, where, orderBy, limit, getDocs } from 'firebase/firestore';

	let notifications = [];
	let activeTab = 'all';

	onMount(async () => {
		const user = auth.currentUser;
		if (user) {
			await loadNotifications();
		}
	});

	async function loadNotifications() {
		try {
			// Query notification history
			const q = query(
				collection(db, 'notification_history'),
				where('userId', '==', auth.currentUser.uid),
				orderBy('timestamp', 'desc'),
				limit(50)
			);

			const querySnapshot = await getDocs(q);
			notifications = querySnapshot.docs.map((doc) => ({
				id: doc.id,
				...doc.data(),
				timestamp: doc.data().timestamp?.toDate()
			}));
		} catch (error) {
			console.error('Error loading notifications:', error);
		}
	}

	function setActiveTab(tab) {
		activeTab = tab;
	}

	function getFilteredNotifications() {
		if (activeTab === 'all') return notifications;
		return notifications.filter((n) => n.category === activeTab);
	}
</script>

<div class="notification-history">
	<h2>Notification History</h2>

	<div class="tabs">
		<button class:active={activeTab === 'all'} on:click={() => setActiveTab('all')}>All</button>
		<button class:active={activeTab === 'emergency'} on:click={() => setActiveTab('emergency')}
			>Emergency</button
		>
		<button class:active={activeTab === 'system'} on:click={() => setActiveTab('system')}
			>System</button
		>
		<button class:active={activeTab === 'reminder'} on:click={() => setActiveTab('reminder')}
			>Reminder</button
		>
		<button class:active={activeTab === 'settings'} on:click={() => setActiveTab('settings')}
			>Settings</button
		>
	</div>

	<div class="notification-list">
		{#each getFilteredNotifications() as notification}
			<div class="notification-card">
				<div class="notification-header">
					<h3>{notification.title}</h3>
					<span class="timestamp">{notification.timestamp?.toLocaleString()}</span>
				</div>
				<p>{notification.body}</p>
				{#if notification.data}
					<div class="notification-data">
						{#if notification.data.city}
							<div class="data-item">
								<span class="label">City:</span>
								<span class="value">{notification.data.city}</span>
							</div>
						{/if}
						{#if notification.data.current_value}
							<div class="data-item">
								<span class="label">Current Value:</span>
								<span class="value">{notification.data.current_value}°C</span>
							</div>
						{/if}
						{#if notification.data.percent_change}
							<div class="data-item">
								<span class="label">Change:</span>
								<span class="value">{notification.data.percent_change}%</span>
							</div>
						{/if}
						{#if notification.data.inet_level}
							<div class="data-item">
								<span class="label">INET Level:</span>
								<span class="value inet-level-{notification.data.inet_level.toLowerCase()}"
									>{notification.data.inet_level}</span
								>
							</div>
						{/if}
					</div>
				{/if}
			</div>
		{/each}

		{#if getFilteredNotifications().length === 0}
			<div class="empty-state">
				<p>No notifications found in this category.</p>
			</div>
		{/if}
	</div>
</div>

<style>
	/* Styles omitted for brevity */
</style>
```

## Permission Management

The application includes a permissions panel (`src/components/permissions-panel.svelte`) to manage notification and location permissions:

```svelte
<script>
	import { onMount } from 'svelte';
	import { initializeFirebaseMessaging } from '$lib/firebase';

	let notificationPermission = 'default';
	let locationPermission = 'default';

	onMount(async () => {
		// Check current notification permission
		notificationPermission = Notification.permission;

		// Check current geolocation permission
		if (navigator.permissions && navigator.permissions.query) {
			const result = await navigator.permissions.query({ name: 'geolocation' });
			locationPermission = result.state;

			// Listen for changes
			result.onchange = () => {
				locationPermission = result.state;
			};
		}
	});

	async function requestNotificationPermission() {
		try {
			await initializeFirebaseMessaging();
			notificationPermission = Notification.permission;
		} catch (error) {
			console.error('Error requesting notification permission:', error);
		}
	}

	function requestLocationPermission() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				() => {
					locationPermission = 'granted';
				},
				() => {
					locationPermission = 'denied';
				}
			);
		}
	}
</script>

<div class="permissions-panel">
	<h2>Permissions</h2>

	<div class="permission-item">
		<div class="permission-info">
			<h3>Notifications</h3>
			<p>Receive alerts about heat index changes and weather conditions</p>
		</div>
		<div class="permission-status">
			<span class="status-indicator status-{notificationPermission}"></span>
			<span class="status-text">{notificationPermission}</span>
			{#if notificationPermission !== 'granted'}
				<button on:click={requestNotificationPermission}>Enable</button>
			{/if}
		</div>
	</div>

	<div class="permission-item">
		<div class="permission-info">
			<h3>Location</h3>
			<p>Provide weather information and health advice based on your location</p>
		</div>
		<div class="permission-status">
			<span class="status-indicator status-{locationPermission}"></span>
			<span class="status-text">{locationPermission}</span>
			{#if locationPermission !== 'granted'}
				<button on:click={requestLocationPermission}>Enable</button>
			{/if}
		</div>
	</div>
</div>

<style>
	/* Styles omitted for brevity */
</style>
```

## Notification Workflow

1. **Trigger Identification**:

   - GitHub Actions runs `heat_index_alert_service.py` on schedule
   - Script detects significant heat index changes (≥15% increase or ≥10% decrease)

2. **Target Selection**:

   - System identifies users who have selected the affected city in preferences
   - Retrieves FCM tokens for eligible users

3. **Notification Creation**:

   - Constructs notification with appropriate title and body based on change type
   - Includes metadata (city, values, percent change, INET level)

4. **Delivery**:

   - Sends notification via Firebase Cloud Messaging to user tokens
   - Records delivery attempt in notification history

5. **User Interaction**:
   - Notification displayed on user's device
   - Clicking notification opens app to relevant view
   - Notification saved in history for later reference

## Configuration and Customization

Notification thresholds and behavior can be customized in the following files:

- **Threshold Configuration**: `src/scripts/heat_index_alert_service.py`

  - `SIGNIFICANT_INCREASE_THRESHOLD`: Default 15% (0.15)
  - `SIGNIFICANT_DECREASE_THRESHOLD`: Default 10% (0.10)

- **Service Worker**: `static/firebase-messaging-sw.js`

  - Controls notification appearance and click behavior
  - Can be modified to customize notification icon, actions, etc.

- **Notification Display**: `src/components/toast-notification.svelte`
  - Handles in-app notification display
  - Customizable styling and interaction behavior
